on:
    push:
        branches:
            - 'main'
            - 'feat/*'
    pull_request:
        types:
            - opened
        branches:
            - 'main'
jobs:
   ios-build:
     name: iOS Dev Build
     runs-on: macOS-latest
     defaults:
      run:
        working-directory: 'RnGhaAppcenterPipeline'
     steps:
       - name: Cancel previous runs
         uses: styfle/cancel-workflow-action@0.9.1
       - name: Checkout repo from dev branch
         uses: actions/checkout@v2
       - name: Install reactnative-cli
         run: npm install -g react-native-cli
       - uses: actions/setup-node@v3
         with:
           node-version: '18'
           cache: 'npm'
           cache-dependency-path: RnGhaAppcenterPipeline/package-lock.json

       - name: Install npm dependencies
         run: npm install  
       - name: Enable Corepack
         run: corepack enable
       - name: install Cocoapod dependencies
         run: |
           cd ios
           pod install          
 
       - name: build archive
         run: |
           cd ios
           xcodebuild -workspace RnGhaAppcenterPipeline.xcworkspace \
           -scheme "RnGhaAppcenterPipeline" \
           -sdk iphoneos \
           -configuration Debug \
           -destination generic/platform=iOS \
           -archivePath $RUNNER_TEMP/RnGhaAppcenterPipeline.xcarchive \
           archive
 
       - name: export ipa
         env:
           EXPORT_OPTIONS_PLIST: ${{ secrets.EXPORT_OPTIONS_PLIST }}
         run: |
           EXPORT_OPTS_PATH=$RUNNER_TEMP/ExportOptions.plist
           echo -n "$EXPORT_OPTIONS_PLIST" | base64 --decode -o $EXPORT_OPTS_PATH
           xcodebuild -exportArchive \
           -archivePath $RUNNER_TEMP/RnGhaAppcenterPipeline.xcarchive \
           -exportOptionsPlist $EXPORT_OPTS_PATH \
           -exportPath $RUNNER_TEMP/build                    
 
       - name: Upload application
         uses: actions/upload-artifact@v3
         with:
           name: app
           path: ${{ runner.temp }}/build/RnGhaAppcenterPipeline.ipa
           # you can also archive the entire directory 
           # path: ${{ runner.temp }}/build
           retention-days: 3
   android-build:
     name: Android Dev Build
     runs-on: ubuntu-latest
     defaults:
      run:
        working-directory: 'RnGhaAppcenterPipeline'
     steps:
       - name: Cancel previous runs
         uses: styfle/cancel-workflow-action@0.9.1
       - name: Checkout repo from dev branch
         uses: actions/checkout@v2
       - name: Install reactnative-cli
         run: npm install -g react-native-cli
       - name: Install npm dependency
         run: npm install
       - name: Setup Android SDK
         uses: android-actions/setup-android@v2
       - uses: actions/cache@v3
         with:
           path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
           key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
           restore-keys: |
            ${{ runner.os }}-gradle-
       - name: Setup Gradle
         uses: gradle/gradle-build-action@v2
       - name: Execute Gradle build
         run: |
           cd android
           chmod +x gradlew
           ./gradlew assemble